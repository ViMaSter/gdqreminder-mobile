name: Android build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      forceRelease:
        description: Force Google Play release?
        required: true
        default: false
        type: boolean

jobs:
  buildAPK:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - run: npm ci
      - run: npm run build
      - run: npx cap sync
      - run: cd android && ./gradlew assembleDebug
        shell: bash

      - uses: actions/upload-artifact@v2
        with:
          name: apk-v${{ github.run_number }}
          path: ./android/app/build/outputs/apk/debug/app-debug.apk

  buildAAB:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - run: npm ci
      - run: npm run build
      - run: npx cap sync
      - run: cd android && ./gradlew :app:bundleRelease
        shell: bash
        
      - uses: actions/upload-artifact@v3
        with:
          name: aab-v${{ github.run_number }}
          path: ./android/app/build/outputs/bundle/release/app-release.aab
          
  determineChanges:
    runs-on: ubuntu-latest
    outputs:
      gradle: ${{ steps.versionChange.outputs.gradle }}
    steps:
    - uses: actions/checkout@v3
    - uses: dorny/paths-filter@v2
      id: versionChange
      with:
        filters: |
          gradle:
            - 'android/app/build.gradle'
       
  publish:
    runs-on: ubuntu-latest
    if: ((github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.determineChanges.outputs.gradle == 'true') || github.event.inputs.forceRelease)
    needs: [buildAAB, determineChanges]
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: aab-v${{ github.run_number }}
          path: aab
      - uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: ./aab
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
      - uses: r0adkll/upload-google-play@v1.0.17
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICEACCOUNTJSON }}
          packageName: ke.mahn.gdqreminder
          track: internal
          status: completed
          releaseFiles: ./aab/app-release.aab
          
  versioning:
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - uses: actions/checkout@v3

      - id: build-gradle
        uses: juliangruber/read-file-action@v1
        with:
          path: ./android/app/build.gradle

      - uses: actions-ecosystem/action-regex-match@v2
        id: version-code
        with:
          text: ${{ steps.build-gradle.outputs.content }}
          regex: 'versionCode (.*)'

      - uses: actions-ecosystem/action-regex-match@v2
        id: version-name
        with:
          text: ${{ steps.build-gradle.outputs.content }}
          regex: 'versionName "(.*)"'

      - name: Echo versionCode
        run: echo "${{ steps.version-code.outputs.group1 }}"

      - name: Echo versionName
        run: echo "${{ steps.version-name.outputs.group1 }}"

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: "${{ steps.version-name.outputs.group1 }}.${{ steps.version-code.outputs.group1 }}"
          tag_prefix: ""
